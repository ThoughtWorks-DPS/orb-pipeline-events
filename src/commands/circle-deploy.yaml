# src/commands/dd-deploy.yaml

description: |
  Send pre-formated, deployment event to be used as universal time-series overlay.

  Fromat is:
    - title: Deployment
    - tags: {"event:deploy"}
    - message: [${CIRCLE_USERNAME}] ${CIRCLE_JOB} ${CIRCLE_TAG} sha:${CIRCLE_SHA1} ${CIRCLE_BUILD_URL}

    you can override the default message.  

parameters:

  message:
    description: Event message
    type: string
    default: "[${CIRCLE_USERNAME}] ${CIRCLE_JOB} ${CIRCLE_TAG} sha:${CIRCLE_SHA1} ${CIRCLE_BUILD_URL}" 

  datadog-api-key:
    description: Setup ~/.dogrc  Default is $DATADODG_API_KEY
    type: string
    default: $DATADOG_API_KEY

  datadog-app-key:
    description: Setup ~/.dogrc  Default is $DATADODG_APP_KEY
    type: string
    default: $DATADOG_APP_KEY

steps:
  # - setup-dd-credentials:
  #     datadog-api-key: << parameters.datadog-api-key >>
  #     datadog-app-key: << parameters.datadog-app-key >>
  - run:
      name: Post standard deployment event
      command: |
        dog event post --api-key << parameters.datadog-api-key >> --application-key << parameters.datadog-app-key >> --tags {"event:deploy"} "Deployment" "<< parameters.message >>"
