# src/commands/dd-deploy.yaml

description: |
  Send pre-formated, deployment event to be used as universal time-series overlay.

  Fromat is:
    - title: Deployment
    - tags: { "event:deploy" }
    - message: 

    you can override the default message.  

parameters:

  message:
    description: Event message
    type: string
    default: "[${CIRCLE_USERNAME}] ${CIRCLE_JOB} ${CIRCLE_TAG} sha:${CIRCLE_SHA1}\n${CIRCLE_BUILD_URL}" 

  datadog-api-key:
    description: Setup ~/.dogrc  Default is $DATADODG_API_KEY
    type: string
    default: $DATADOG_API_KEY

  datadog-app-key:
    description: Setup ~/.dogrc  Default is $DATADODG_APP_KEY
    type: string
    default: $DATADOG_APP_KEY
    
steps:
  - run:
      name: setup .dogrc
      command: |
        cat \<<EOF > ~/.dogrc
        [Connection]
        apikey = << parameters.datadog-api-key >>
        appkey = << parameters.datadog-api-key >>
        EOF
  - run:
      name: Post standard deployment event
      command: |
        dog event post \
          --tags { "event:deploy" } "Deployment" "<< parameters.message >>"