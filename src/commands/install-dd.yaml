# src/commands/install-dd.yaml

description: |
  Install datadog cli (dog).

  Supports Alpine and debian/ubuntu install methods, sudo is assumed required. Default is Alpine.

parameters:

  os:
    description: OS install type. Default Alpine.
    type: enum
    enum: ["Alpine","Debian"]
    default: Alpine

  datadog-api-key:
    description: Setup ~/.dogrc  Default is $DATADODG_API_KEY
    type: string
    default: $DATADOG_API_KEY

  datadog-app-key:
    description: Setup ~/.dogrc  Default is $DATADODG_APP_KEY
    type: string
    default: $DATADOG_APP_KEY

steps:
  - when:
      condition:
        equals: [ << parameters.os >>, "Alpine" ]
      steps:
        - run:
            name: Install datadog cli to Alpine executor
            command: |
              sudo apk add --no-cache python3
              sudo python3 -m ensurepip
              sudo rm -r /usr/lib/python*/ensurepip
              sudo pip3 install --upgrade pip
              if [ ! -e /usr/bin/pip ]; then sudo ln -s /usr/bin/pip3 /usr/bin/pip ; fi
              sudo ln -s /usr/bin/pydoc3 /usr/bin/pydoc
              sudo ln -s /usr/bin/python3 /usr/bin/python
              sudo ln -s /usr/bin/python3-config /usr/bin/python-config
              sudo pip install --no-binary datadog
              dog --version
  - when:
      condition:
        equals: [ << parameters.os >>, "Debian" ]
      steps:
        - run:
            name: Install datadog cli to Alpine executor
            command: |
              sudo apt-get update
              sudo apt-get install --no-install-recommends -y python3-dev python3-pip
              sudo ln -s /usr/bin/pydoc3 /usr/bin/pydoc
              sudo ln -s /usr/bin/python3 /usr/bin/python
              sudo ln -s /usr/bin/python3-config /usr/bin/python-config
              sudo pip install --no-binary datadog
              dog --version
  - run:
      name: setup .dogrc
      command: |
        cat <<EOF > ~/.dogrc
        [Connection]
        apikey = << parameters.datadog-api-key >>
        appkey = << parameters.datadog-api-key >>
        EOF
