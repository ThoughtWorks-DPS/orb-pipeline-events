# src/commands/slack-bot.yaml
# yamllint disable rule:line-length
---
description: |
  Post message to slack channel via webhook.

  parameters:
  - channel = slack channel
  - use custom-message to provide complete custom message block json body
  - set include-link = ture to add button that links back to pipeline url

parameters:

  bot-token:
    description: slack-bot api token
    type: string
    default: $SLACK_BOT_TOKEN

  channel:
    description: post message to this channel
    type: string
    
  message:
    description: Event message
    type: string
    default: "unconfigured message: [${CIRCLE_USERNAME}] ${CIRCLE_JOB} ${CIRCLE_TAG} sha:${CIRCLE_SHA1} ${CIRCLE_BUILD_URL}"

  custom-message:
    description: Use custom message instead of default
    type: string
    default: ""

  include-link:
    description: include link back to pipeline
    type: boolean
    default: false

steps:
  - unless:
      name: post default bot message
      condition: << parameters.custom-message >>
      steps:
        - run:
            name: post default bot message
            environment:
              CHANNEL: << parameters.channel >>
              MESSAGE: << parameters.message >>
              CUSTOM_MESSAGE: << parameters.custom-message >>
              INCLUDE_LINK: << parameters.include-link >>
              CIRCLE_BUILD_URL: $CIRCLE_BUILD_URL
              SLACK_BOT_TOKEN: << parameters.bot-token >>
            command: <<include(scripts/slack-bot-message.sh)>>
  # - when:
  #     name: post default bot message
  #     condition: << parameters.custom-message >>
  #     steps:
  #       - run:
  #           name: post default bot message
  #           command: |
  #             msg=$(cat <<EOF
  #             '{"channel": "<< parameters.channel >>","blocks": [{"type": "section","text": {"type": "mrkdwn","text": "<< parameters.message >>"}},{"type": "divider"},{"type": "actions","elements": [{"type": "button","text": {"type": "plain_text","text": "go to pipeline","emoji": true},"value": "pipeline","url": "<< parameters.url >>"}]}]}'
  #             EOF)
  #             curl -H "Content-type: application/json" \
  #                  --data $msg \
  #                  -H "Authorization: Bearer << parameters.bot-token >>" \
  #                  -X POST https://slack.com/api/chat.postMessage
