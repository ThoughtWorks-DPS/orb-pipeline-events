# src/commands/dd-install.yaml

description: |
  Install datadog cli (dog).

  Supports Alpine and debian/ubuntu install methods, sudo is assumed to be required. Default is Alpine.

parameters:

  install-python:
    description: Need to install python3 first to support datadog pip package installation
    type: boolean
    default: false

  os:
    description: OS install type. Default Alpine.
    type: enum
    enum: ["Alpine","Debian"]
    default: Alpine

steps:
  - when:
      name: Install python3 first
      condition: << parameters.install-python >>
      steps:
        - when:
            condition: 
              equal: [ "Alpine", << parameters.os >> ]
            steps:
              - run:
                  command: |
                    sudo apk add --no-cache python3
                    sudo rm -r /usr/lib/python*/ensurepip
                    sudo pip3 install --upgrade pip
                    if [ ! -e /usr/bin/pip ]; then sudo ln -s /usr/bin/pip3 /usr/bin/pip ; fi
                    sudo ln -s /usr/bin/pydoc3 /usr/bin/pydoc
        - when:
            condition: 
              equal: [ "Debian", << parameters.os >> ]
            steps:
              - run:
                  command: |
                    sudo apt-get update
                    sudo apt-get install --no-install-recommends -y python3-dev python3-pip
                    sudo ln -sf /usr/bin/pydoc3 /usr/bin/pydoc
                    sudo ln -sf /usr/bin/python3 /usr/bin/python
                    sudo ln -sf /usr/bin/python3-config /usr/bin/python-config
  - run:
      name: install datadog cli 
      command: |
        sudo pip install --no-binary datadog
        dog --version
